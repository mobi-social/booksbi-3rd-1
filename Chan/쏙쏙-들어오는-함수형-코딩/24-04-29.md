# 4.29 (~165p까지)

## 신뢰할수 없는 코드를 쓰면서 불변성 지키기

### 카피 온 라이트의 한계

카피온 라이트는 얕은 복사를 해서 데이터를 다루는데 만약 추가적으로 다뤄야할 데이터가 레거시코드(외부 라이브러리,or 외부에서 계산돼서 넘어오는 데이터)인 경우 데이터의 안전성을 신뢰할 수 없다. _어떻게 데이터가 바뀔지 확신할 수 없기때문에._ 이때 적용할 수 있는 방법이 **방어적 복사** 이다.

### 방어적 복사

방어적 복사는 외부에서 넘어오거나 외부로 보내줄 데이터를 안전하게 다루기 위한 방법이다. 깊은 복사를 사용한다.
ex)

- 1.외부로 부터 데이터 유입
- 2.데이터를 먼저 깊은복사
- 3.바뀔 수 있는 원본데이터는 버리고 바뀌지 않을 복사본 데이터를 저장한다.

다음과 같은 방식으로 데이터의 안정성을 확보 할 수 있다.

대부분의 웹API에서 방어적 복사를 사용하는데 이를 통해 서비스간 문제없이 소통할수있다.

### 비용이 많이 든다

얕은복사는 원본의 주소값을 같이 참조하기때문에 비용이 싼 과정이라고 볼 수 있다. 반면 깊은복사를 하면 기존 데이터와 같은 정보를 가지며 주소값또한 다른 새로운 데이터를 메모리에 저장하기때문에 비용이 비싼 작업이다.
따라서 카피 온 라이트로 해결할 수 있는 데이터는 비용이 싼 작업을 택하는것이 좋다.

### JS에서 깊은 복사 구현하기

글에서는 lodash라이브러리의 .clonedeep()을통해 깊은 복사를 할 것을 추천한다.

JS에서 이를 구현하기위해서는 깊은복사 함수를 정의하고
그안에서 데이터의 모든 요소를 순회하며 새로운 데이터를 복사하는 과정을 거쳐야한다. 하지만 배열이나 객체의 경우에만 문제없이 동작할 것이고 완벽하게 구현하긴 힘들다고 한다.
